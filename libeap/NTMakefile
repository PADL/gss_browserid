########################################################################
#
# Copyright (c) 2009, Secure Endpoints Inc.
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 
# - Redistributions of source code must retain the above copyright
#   notice, this list of conditions and the following disclaimer.
# 
# - Redistributions in binary form must reproduce the above copyright
#   notice, this list of conditions and the following disclaimer in
#   the documentation and/or other materials provided with the
#   distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
# FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
# COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
# BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
# ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
# 

RELDIR=libeap

!include ../windows/NTMakefile.w32 

#
# Common object files
#
SOURCES_BOTH = src\eap_common\eap_peap_common.c \
	src\eap_common\eap_psk_common.c \
	src\eap_common\eap_pax_common.c \
	src\eap_common\eap_sake_common.c \
	src\eap_common\eap_gpsk_common.c \
	src\eap_common/eap_common.c \
	src\eap_common\chap.c

OBJS_BOTH = $(OBJ)\eap_common\eap_peap_common.obj \
	$(OBJ)\eap_common\eap_psk_common.obj \
	$(OBJ)\eap_common\eap_pax_common.obj \
	$(OBJ)\eap_common\eap_sake_common.obj \
	$(OBJ)\eap_common\eap_gpsk_common.obj \
	$(OBJ)\eap_common\eap_common.obj \
	$(OBJ)\eap_common\chap.obj

SOURCES_peer = src/eap_peer/eap_tls.c \
	src/eap_peer/eap_peap.c \
	src/eap_peer/eap_ttls.c \
	src/eap_peer/eap_md5.c \
	src/eap_peer/eap_mschapv2.c \
	src/eap_peer/mschapv2.c \
	src/eap_peer/eap_otp.c \
	src/eap_peer/eap_gtc.c \
	src/eap_peer/eap_leap.c \
	src/eap_peer/eap_psk.c \
	src/eap_peer/eap_pax.c \
	src/eap_peer/eap_sake.c \
	src/eap_peer/eap_gpsk.c \
	src/eap_peer/eap.c \
	src/eap_peer/eap_methods.c \
	src/eap_peer/eap_tls_common.c

OBJS_peer = $(OBJ)\eap_peer\eap_tls.obj \
	$(OBJ)\eap_peer\eap_peap.obj \
	$(OBJ)\eap_peer\eap_ttls.obj \
	$(OBJ)\eap_peer\eap_md5.obj \
	$(OBJ)\eap_peer\eap_mschapv2.obj \
	$(OBJ)\eap_peer\mschapv2.obj \
	$(OBJ)\eap_peer\eap_otp.obj \
	$(OBJ)\eap_peer\eap_gtc.obj \
	$(OBJ)\eap_peer\eap_leap.obj \
	$(OBJ)\eap_peer\eap_psk.obj \
	$(OBJ)\eap_peer\eap_pax.obj \
	$(OBJ)\eap_peer\eap_sake.obj \
	$(OBJ)\eap_peer\eap_gpsk.obj \
	$(OBJ)\eap_peer\eap.obj \
	$(OBJ)\eap_common\eap_common.obj \
	$(OBJ)\eap_peer\eap_methods.obj \
	$(OBJ)\eap_peer\eap_tls_common.obj

GCOPTS=-I$(SRCDIR) \
	-I$(SRCDIR)/eap_example \
	-I$(SRCDIR)/src \
	-I$(SRCDIR)/src/utils \
	-I$(SRCDIR)/src/crypto \
	-I$(SRCDIR)/src/tls \
	-I$(OBJ) \
	-D__func__=__FUNCTION__ \
	-DEAP_TLS \
	-DEAP_PEAP \
	-DEAP_TTLS \
	-DEAP_MD5 \
	-DEAP_MSCHAPv2 \
	-DEAP_GTC \
	-DEAP_OTP \
	-DEAP_LEAP \
	-DEAP_PSK \
	-DEAP_PAX \
	-DEAP_SAKE \
	-DEAP_GPSK \
	-DEAP_GPSK_SHA256 \
	-DEAP_SERVER_IDENTITY \
	-DEAP_SERVER_TLS \
	-DEAP_SERVER_PEAP \
	-DEAP_SERVER_TTLS \
	-DEAP_SERVER_MD5 \
	-DEAP_SERVER_MSCHAPV2 \
	-DEAP_SERVER_GTC \
	-DEAP_SERVER_PSK \
	-DEAP_SERVER_PAX \
	-DEAP_SERVER_SAKE \
	-DEAP_SERVER_GPSK \
	-DEAP_SERVER_GPSK_SHA256 \
	-DIEEE8021X_EAPOL \
	-DCONFIG_NATIVE_WINDOWS \
	-DCONFIG_INTERNAL_LIBTOMMATH \
	-DCONFIG_CRYPTO_INTERNAL\
	-DCONFIG_TLS_INTERNAL_CLIENT

UTILS_SRCS = src/utils/base64.c \
	src/utils/common.c \
	src/utils/ip_addr.c \
	src/utils/trace.c \
	src/utils/uuid.c \
	src/utils/wpa_debug.c \
	src/utils/wpabuf.c \
	src/utils/os_win32.c

UTILS_OBJS = $(OBJ)\utils\base64.obj \
	$(OBJ)\utils\common.obj \
	$(OBJ)\utils\ip_addr.obj \
	$(OBJ)\utils\trace.obj \
	$(OBJ)\utils\uuid.obj \
	$(OBJ)\utils\wpa_debug.obj \
	$(OBJ)\utils\wpabuf.obj \
	$(OBJ)\utils\os_win32.obj

CRYPTO_SRCS = \
    src/crypto/aes-cbc.c \
    src/crypto/aes-ctr.c \
    src/crypto/aes-eax.c \
    src/crypto/aes-encblock.c \
    src/crypto/aes-internal.c \
    src/crypto/aes-internal-dec.c \
    src/crypto/aes-internal-enc.c \
    src/crypto/aes-omac1.c \
    src/crypto/aes-unwrap.c \
    src/crypto/aes-wrap.c \
    src/crypto/des-internal.c \
    src/crypto/dh_group5.c \
    src/crypto/dh_groups.c \
    src/crypto/md4-internal.c \
    src/crypto/md5.c \
    src/crypto/md5-internal.c \
    src/crypto/md5-non-fips.c \
    src/crypto/milenage.c \
    src/crypto/ms_funcs.c \
    src/crypto/rc4.c \
    src/crypto/sha1.c \
    src/crypto/sha1-internal.c \
    src/crypto/sha1-pbkdf2.c \
    src/crypto/sha1-tlsprf.c \
    src/crypto/sha1-tprf.c \
    src/crypto/sha256.c \
    src/crypto/sha256-internal.c \
    src/crypto/crypto_internal.c \
    src/crypto/crypto_internal-cipher.c \
    src/crypto/crypto_internal-modexp.c \
    src/crypto/crypto_internal-rsa.c \
    src/crypto/tls_internal.c \
    src/crypto/fips_prf_internal.c

CRYPTO_OBJS = \
    $(OBJ)\crypto\aes-ctr.obj \
    $(OBJ)\crypto\aes-eax.obj \
    $(OBJ)\crypto\aes-encblock.obj \
    $(OBJ)\crypto\aes-omac1.obj \
    $(OBJ)\crypto\aes-unwrap.obj \
    $(OBJ)\crypto\aes-wrap.obj \
    $(OBJ)\crypto\crypto_cryptoapi.obj \
    $(OBJ)\crypto\dh_group5.obj \
    $(OBJ)\crypto\fips_prf_internal.obj \
    $(OBJ)\crypto\dh_groups.obj \
    $(OBJ)\crypto\md5.obj \
    $(OBJ)\crypto\md5-non-fips.obj \
    $(OBJ)\crypto\milenage.obj \
    $(OBJ)\crypto\ms_funcs.obj \
    $(OBJ)\crypto\random.obj \
    $(OBJ)\crypto\rc4.obj \
    $(OBJ)\crypto\sha1.obj \
    $(OBJ)\crypto\sha1-pbkdf2.obj \
    $(OBJ)\crypto\sha1-tlsprf.obj \
    $(OBJ)\crypto\sha1-tprf.obj \
    $(OBJ)\crypto\sha256.obj \
    $(OBJ)\crypto\sha256-internal.obj \
    $(OBJ)\crypto\tls_internal.obj

TLS_SRCS = \
    src/tls/asn1.c \
    src/tls/bignum.c \
    src/tls/pkcs1.c \
    src/tls/pkcs5.c \
    src/tls/pkcs8.c \
    src/tls/rsa.c \
    src/tls/tlsv1_client.c \
    src/tls/tlsv1_client_read.c \
    src/tls/tlsv1_client_write.c \
    src/tls/tlsv1_common.c \
    src/tls/tlsv1_cred.c \
    src/tls/tlsv1_record.c \
    src/tls/tlsv1_server.c \
    src/tls/tlsv1_server_read.c \
    src/tls/tlsv1_server_write.c \
    src/tls/x509v3.c

TLS_OBJS = \
    $(OBJ)\tls\asn1.obj \
    $(OBJ)\tls\bignum.obj \
    $(OBJ)\tls\pkcs1.obj \
    $(OBJ)\tls\pkcs5.obj \
    $(OBJ)\tls\pkcs8.obj \
    $(OBJ)\tls\rsa.obj \
    $(OBJ)\tls\tlsv1_client.obj \
    $(OBJ)\tls\tlsv1_client_read.obj \
    $(OBJ)\tls\tlsv1_client_write.obj \
    $(OBJ)\tls\tlsv1_common.obj \
    $(OBJ)\tls\tlsv1_cred.obj \
    $(OBJ)\tls\tlsv1_record.obj \
    $(OBJ)\tls\tlsv1_server.obj \
    $(OBJ)\tls\tlsv1_server_read.obj \
    $(OBJ)\tls\tlsv1_server_write.obj \
    $(OBJ)\tls\x509v3.obj

{$(OBJ)\src\eap_common}.c{$(OBJ)\eap_common}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\eap_common\ -Fd($OBJ)\eap_common\ -I$(OBJ)\eap_common $(GCOPTS)

{src\eap_common}.c{$(OBJ)\eap_common}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\eap_common\ -Fd$(OBJ)\eap_common\ -I$(OBJ)\eap_common $(GCOPTS)

{$(OBJ)\src\eap_peer}.c{$(OBJ)\eap_peer}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\eap_peer\ -Fd($OBJ)\eap_peer\ -I$(OBJ)\eap_peer $(GCOPTS)

{src\eap_peer}.c{$(OBJ)\eap_peer}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\eap_peer\ -Fd$(OBJ)\eap_peer\ -I$(OBJ)\eap_peer $(GCOPTS)

{$(OBJ)\src\utils}.c{$(OBJ)\utils}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\utils\ -Fd($OBJ)\utils\ -I$(OBJ)\utils $(GCOPTS)

{src\utils}.c{$(OBJ)\utils}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\utils\ -Fd$(OBJ)\utils\ -I$(OBJ)\utils $(GCOPTS)

{$(OBJ)\src\crypto}.c{$(OBJ)\crypto}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\crypto\ -Fd($OBJ)\crypto\ -I$(OBJ)\crypto $(GCOPTS)

{src\crypto}.c{$(OBJ)\crypto}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\crypto\ -Fd$(OBJ)\crypto\ -I$(OBJ)\crypto $(GCOPTS)

{$(OBJ)\src\tls}.c{$(OBJ)\tls}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\tls\ -Fd($OBJ)\tls\ -I$(OBJ)\tls $(GCOPTS)

{src\tls}.c{$(OBJ)\tls}.obj::
	$(C2OBJ_NP) -Fo$(OBJ)\tls\ -Fd$(OBJ)\tls\ -I$(OBJ)\tls $(GCOPTS)

$(LIBEAP): $(OBJS_BOTH) $(OBJS_peer) $(UTILS_OBJS) $(CRYPTO_OBJS) $(TLS_OBJS)
	$(LIBCON)

all:: $(LIBEAP)

prep:: mkdirs-libeap

mkdirs-libeap:
!if !exist($(OBJ)\eap_common)
	$(MKDIR) $(OBJ)\eap_common
!endif
!if !exist($(OBJ)\eap_peer)
	$(MKDIR) $(OBJ)\eap_peer
!endif
!if !exist($(OBJ)\utils)
	$(MKDIR) $(OBJ)\utils
!endif
!if !exist($(OBJ)\crypto)
	$(MKDIR) $(OBJ)\crypto
!endif
!if !exist($(OBJ)\tls)
	$(MKDIR) $(OBJ)\tls
!endif

clean::
	rm -f $(OBJS_BOTH) $(OBJS_peer) $(UTILS_OBJS) $(CRYPTO_OBJS) $(TLS_OBJS)
